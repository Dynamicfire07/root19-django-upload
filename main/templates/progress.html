{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Progress</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    {% include '_app_styles.html' %}
    <style>
        .progress-hero { background: linear-gradient(135deg,#0f172a,#0b5ed7); color:#fff; border-radius:16px; padding:1.5rem; box-shadow:0 1.2rem 2.4rem rgba(0,0,0,.12); }
        .progress-card { background:#fff; border:1px solid var(--border); border-radius:16px; padding:1.25rem; box-shadow:0 1rem 2rem rgba(0,0,0,.06); height:100%; }
        .checklist-card { border:1px solid var(--border); border-radius:12px; padding:.9rem 1rem; background:#fff; display:flex; align-items:center; gap:.85rem; box-shadow:0 .8rem 1.5rem rgba(0,0,0,.04); }
        .checklist-card:hover { border-color:#cbd5e1; }
        .pill-ghost { display:inline-flex; align-items:center; gap:.35rem; padding:.4rem .8rem; border-radius:999px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.2); font-weight:600; }
    </style>
</head>
<body class="stats-page">
    {% include 'navbar.html' %}

    <main class="py-4 py-md-5">
        <div class="container">
            <div class="progress-hero d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                <div>
                    <div class="pill-ghost text-white-75">
                        <span class="icon-dot"></span>
                        Study progress
                    </div>
                    <h1 class="mt-2 mb-1 fw-bold">Track your sessions</h1>
                    <p class="mb-0 text-white-75">Select a session, tick subtopics you have completed, and save it for next time.</p>
                </div>
                <div class="text-end">
                    <div class="pill-ghost">
                        {{ selected_label|default:"Choose a session" }}
                        {% if selected_display %} ({{ selected_display }}){% endif %}
                    </div>
                    <div class="small text-white-75">Progress saves automatically when you hit "Save checklist".</div>
                </div>
            </div>

            <div class="row g-3 mt-3">
                <div class="col-lg-4">
                    <div class="progress-card">
                        <h5 class="fw-bold mb-2">Session</h5>
                        {% if sessions %}
                            <form method="get" class="d-grid gap-2">
                                <label class="form-label mb-1 text-muted small">Pick a session</label>
                                <select name="session" class="form-select" onchange="this.form.submit()">
                                    {% for opt in sessions %}
                                        <option value="{{ opt.code }}" {% if opt.code == selected_session %}selected{% endif %}>{{ opt.label }} ({{ opt.display }})</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Switch sessions to see different subtopics.</small>
                            </form>
                        {% else %}
                            <p class="text-muted mb-0">No sessions available yet.</p>
                        {% endif %}
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="progress-card h-100">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h5 class="fw-bold mb-0">Checklist</h5>
                                <small class="text-muted">Mark subtopics as you complete them.</small>
                            </div>
                            <button id="save-progress" class="btn btn-primary" {% if not selected_session %}disabled{% endif %}>
                                <i class="bi bi-check2-circle me-1"></i>Save checklist
                            </button>
                        </div>
                        <div id="save-status" class="alert alert-success py-2 px-3 d-none mb-3">
                            Saved! Your checklist is up to date.
                        </div>
                        {% if checklist %}
                            <div class="d-grid gap-2">
                                {% for item in checklist %}
                                    <label class="checklist-card mb-0" for="subtopic-{{ forloop.counter }}">
                                        <input class="form-check-input mt-0" type="checkbox" id="subtopic-{{ forloop.counter }}" data-subtopic="{{ item.subtopic }}" {% if item.completed %}checked{% endif %}>
                                        <div>
                                            <div class="fw-semibold">{{ item.subtopic }}</div>
                                            <div class="text-muted small">Click to toggle completion</div>
                                        </div>
                                    </label>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-muted">No subtopics found for this session. Try another session code.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    {% include 'footer.html' %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const saveBtn = document.getElementById("save-progress");
        const statusBox = document.getElementById("save-status");

        if (saveBtn) {
            saveBtn.addEventListener("click", function() {
                const sessionCode = "{{ selected_session }}";
                if (!sessionCode) {
                    statusBox.classList.remove("d-none");
                    statusBox.classList.add("alert-danger");
                    statusBox.textContent = "Select a session first.";
                    return;
                }
                const items = Array.from(document.querySelectorAll('[data-subtopic]')).map(el => ({
                    subtopic: el.getAttribute('data-subtopic'),
                    completed: el.checked,
                }));

                fetch("{% url 'save_progress' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken") || "",
                    },
                    body: JSON.stringify({ session_code: sessionCode, items }),
                }).then(res => res.json())
                  .then(data => {
                      statusBox.classList.toggle("d-none", !data.status);
                      statusBox.classList.toggle("alert-danger", !!data.error);
                      if (data.error) {
                          statusBox.textContent = data.error || "Could not save progress.";
                      } else {
                          statusBox.textContent = "Saved! Your checklist is up to date.";
                      }
                  }).catch(() => {
                      statusBox.classList.remove("d-none");
                      statusBox.classList.add("alert-danger");
                      statusBox.textContent = "Could not save progress.";
                  });
            });
        }
    </script>
</body>
</html>
