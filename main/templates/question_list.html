<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Question List</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    {% include '_app_styles.html' %}
    {% include '_analytics_head.html' %}
    {% include '_favicon.html' %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif; background: var(--bg, #f7f8fb); color: var(--text, #0f172a); }
        .ql-hero { background: linear-gradient(135deg, #0f172a, var(--primary, #0b5ed7)); color: #fff; border-radius: 16px; padding: 1.5rem; box-shadow: 0 1.2rem 2.4rem rgba(0,0,0,.12); }
        .ql-card { background: #fff; border: 1px solid var(--border, #e5e7eb); border-radius: 16px; box-shadow: 0 1rem 2rem rgba(0,0,0,.06); padding: 1.5rem; }
        .form-control, .form-select { border-radius: 12px; padding: .85rem 1rem; border: 1px solid var(--border, #e5e7eb); }
        .form-control:focus, .form-select:focus { box-shadow: 0 0 0 4px var(--ring, rgba(13,110,253,.18)); border-color: var(--primary, #0b5ed7); }
        table { width: 100%; }
        .table thead { background: var(--primary, #0d6efd); color: #fff; }
        .table th, .table td { vertical-align: middle; }
        .table img { border-radius: 8px; border: 1px solid var(--border, #e5e7eb); }
    </style>
</head>
<body>
    {% include 'navbar.html' %}
    <div class="container py-5">
        <div class="ql-hero mb-4">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                <div>
                    <div class="text-uppercase small text-white-50 fw-semibold">Root 19</div>
                    <h1 class="mb-0">Question List</h1>
                </div>
                <div class="d-flex gap-2 flex-wrap text-white-75">
                    <span><i class="bi bi-search"></i> Filter by session & subtopic</span>
                    <span><i class="bi bi-eye"></i> Preview questions inline</span>
                </div>
            </div>
        </div>

        <div class="ql-card">
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="session_code" class="form-label fw-semibold">Session Code</label>
                    <select id="session_code" class="form-select">
                        <option value="" selected>Select a session code</option>
                        {% for question in questions %}
                        <option value="{{ question.session_code }}">{{ question.session_code }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="subtopic" class="form-label fw-semibold">Subtopic</label>
                    <select id="subtopic" class="form-select" disabled>
                        <option value="" selected>Select a subtopic</option>
                    </select>
                </div>
            </div>
            <p class="small text-muted mb-4" id="filter-note">
                If no syllabus code or subtopic is chosen, questions are shown in random order from everything.
                If you choose a syllabus code without a subtopic, questions are shown in random order within that syllabus code only.
            </p>

            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Question ID</th>
                            <th>Session</th>
                            <th>Year</th>
                            <th>Paper</th>
                            <th>Variant</th>
                            <th>Subtopic</th>
                            <th>Image</th>
                            <th>Answer</th>
                        </tr>
                    </thead>
                    <tbody id="question-table-body">
                        {% for question in questions %}
                        <tr data-session="{{ question.session_code }}" data-subtopic="{{ question.subtopic }}">
                            <td>{{ question.question_id }}</td>
                            <td>{{ question.session_code }}</td>
                            <td>{{ question.year }}</td>
                            <td>{{ question.paper_code }}</td>
                            <td>{{ question.variant }}</td>
                            <td>{{ question.subtopic }}</td>
                            <td><img src="data:image/png;base64,{{ question.image_base64 }}" alt="Question Image" width="100"></td>
                            <td>{{ question.answer }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% include 'footer.html' %}
    <script>
        const allRows = Array.from(document.querySelectorAll('#question-table-body tr'));

        function shuffle(array) {
            const copy = [...array];
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }

        $('#session_code').change(function () {
            const sessionCode = $(this).val();
            const subtopicDropdown = $('#subtopic');
            
            subtopicDropdown.empty().append('<option value="" disabled selected>Loading...</option>');
            subtopicDropdown.prop('disabled', true);

            $.get('/get-subtopics/', { session_code: sessionCode }, function (data) {
                if (data.subtopics) {
                    subtopicDropdown.empty().append('<option value="" selected>Select a subtopic</option>');
                    data.subtopics.forEach(subtopic => {
                        subtopicDropdown.append(`<option value="${subtopic}">${subtopic}</option>`);
                    });
                    subtopicDropdown.prop('disabled', false);
                    filterTable(sessionCode, null);
                } else {
                    alert('No subtopics found for this session code.');
                }
            }).fail(function () {
                alert('Failed to load subtopics. Please try again.');
            });
        });

        $('#subtopic').change(function () {
            const sessionCode = $('#session_code').val();
            const subtopic = $(this).val();
            filterTable(sessionCode, subtopic);
        });

        function filterTable(sessionCode, subtopic) {
            let rowsToShow = allRows;

            if (!sessionCode && !subtopic) {
                rowsToShow = shuffle(allRows);
            } else if (sessionCode && !subtopic) {
                rowsToShow = shuffle(allRows.filter(row => row.dataset.session === sessionCode));
            } else {
                rowsToShow = allRows.filter(row => {
                    const matchSession = sessionCode ? row.dataset.session === sessionCode : true;
                    const matchSub = subtopic ? row.dataset.subtopic === subtopic : true;
                    return matchSession && matchSub;
                });
            }

            const tbody = document.getElementById('question-table-body');
            tbody.innerHTML = '';
            rowsToShow.forEach(row => {
                row.style.display = '';
                tbody.appendChild(row);
            });
        }

        // Initial random view when no filters are selected
        filterTable("", "");
    </script>
</body>
</html>
