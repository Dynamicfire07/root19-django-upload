<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Duels • ROOT 19</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
    {% include '_app_styles.html' %}
    {% include '_analytics_head.html' %}
    {% include '_favicon.html' %}
    <style>
      body { font-family: 'Space Grotesk', system-ui, -apple-system, sans-serif; background:#f7f8fb; }
      .duel-hero { background: linear-gradient(135deg, #0f172a, #2563eb); color:#fff; border-radius: 18px; padding: 2rem; box-shadow: 0 1.2rem 2.4rem rgba(0,0,0,.16); }
      .pill { display:inline-flex; align-items:center; gap:.35rem; padding:.45rem .8rem; border-radius: 999px; background: rgba(255,255,255,.14); border:1px solid rgba(255,255,255,.22); font-weight:700; }
      .duel-card { background:#fff; border:1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 1rem 2rem rgba(0,0,0,.06); }
      .duel-card .form-control, .duel-card .form-select { border-radius: 12px; padding:.85rem 1rem; }
      .duel-card .form-control:focus, .duel-card .form-select:focus { box-shadow: 0 0 0 4px rgba(37,99,235,.12); border-color:#2563eb; }
      .btn-primary { border-radius: 12px; font-weight: 700; }
      .status-badge { display:inline-flex; align-items:center; gap:.35rem; padding:.4rem .75rem; border-radius: 10px; background:#eef2ff; color:#312e81; font-weight:700; }
      .code-box { font-family: 'Space Grotesk', monospace; letter-spacing: .1em; font-size: 1.1rem; background:#0f172a; color:#fff; padding:.75rem 1rem; border-radius: 12px; }
    </style>
</head>
<body class="bg-light">
  {% include 'navbar.html' %}
  <div class="container py-5">
    <div class="duel-hero mb-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3">
        <div>
          <div class="text-uppercase small text-white-50 fw-semibold">Root 19</div>
          <h1 class="mb-1">Duels</h1>
          <p class="mb-0 text-white-75">Spin up a party code, invite a friend, and compete on the same question set.</p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
          <span class="pill"><i class="bi bi-lightning-charge"></i> Race mode</span>
          <span class="pill"><i class="bi bi-link-45deg"></i> Party codes</span>
          <span class="pill"><i class="bi bi-shield-check"></i> Fair questions</span>
        </div>
      </div>
    </div>

    {% if not user_id %}
      <div class="alert alert-warning mb-4">Log in to create or join a duel.</div>
    {% endif %}

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="duel-card p-4 h-100">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Create Duel</h2>
            <span class="status-badge"><i class="bi bi-plus-circle"></i> New code</span>
          </div>
          <form id="duelCreateForm" class="row g-3">
            <div class="col-12">
              <label class="form-label fw-semibold">Question scope</label>
              <select class="form-select" name="syllabus_code">
                <option value="">All sessions</option>
                {% for opt in session_options %}
                <option value="{{ opt.code }}">{{ opt.label }} ({{ opt.display }})</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-semibold">Questions</label>
              <input type="number" min="1" max="20" value="5" class="form-control" name="question_count">
              <div class="form-text">Race to finish these; fastest with most correct wins.</div>
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-rocket-takeoff me-1"></i> Create duel
              </button>
            </div>
          </form>
          <div id="duelCreated" class="mt-4 d-none">
            <p class="mb-1 text-muted small">Share this code with your opponent:</p>
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="code-box" id="duelCode">------</span>
              <button class="btn btn-outline-secondary btn-sm" id="copyCodeBtn"><i class="bi bi-clipboard"></i> Copy</button>
              <a class="btn btn-outline-primary btn-sm" id="playLink" href="#"><i class="bi bi-controller"></i> Open duel</a>
            </div>
            <div class="mt-2 text-muted small" id="duelStatus">Waiting for opponent...</div>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="duel-card p-4 h-100">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="h5 mb-0">Join Duel</h2>
            <span class="status-badge" style="background:#ecfdf3;color:#166534;"><i class="bi bi-people"></i> Team up</span>
          </div>
          <form id="duelJoinForm" class="row g-3">
            <div class="col-12">
              <label class="form-label fw-semibold">Party code</label>
              <input type="text" class="form-control" name="code" placeholder="e.g., F3G9KD" value="{{ prefill_code }}">
            </div>
            <div class="col-12 d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-door-open me-1"></i> Join duel
              </button>
            </div>
          </form>
          <div class="mt-4">
            <h3 class="h6 fw-semibold mb-1">How it works</h3>
            <ul class="small text-muted mb-0">
              <li>Create a code, share it, and wait for your opponent.</li>
              <li>Once they join, both of you get the same ordered questions.</li>
              <li>Timer starts on join; submit once—no edits after.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="duel-card mt-4 p-4">
      <div class="row g-3 align-items-center">
        <div class="col-md-3">
          <div class="fw-semibold">Checklist</div>
        </div>
        <div class="col-md-9">
          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-light text-dark border"><i class="bi bi-clock-history me-1"></i> Timer enforced server-side</span>
            <span class="badge bg-light text-dark border"><i class="bi bi-journal-check me-1"></i> Fixed question order</span>
            <span class="badge bg-light text-dark border"><i class="bi bi-bar-chart-steps me-1"></i> Clear states: pending/active/completed</span>
            <span class="badge bg-light text-dark border"><i class="bi bi-bell me-1"></i> Live status polling</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const userId = "{{ user_id|default:'' }}";
    const statusBox = document.getElementById('duelStatus');
    const codeBox = document.getElementById('duelCode');
    const playLink = document.getElementById('playLink');
    const createdWrap = document.getElementById('duelCreated');
    let pollTimer = null;
    let activeDuelId = null;

    function setStatus(text) {
      if (statusBox) statusBox.textContent = text;
    }

    function startPolling(duelId) {
      activeDuelId = duelId;
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try {
          const res = await fetch(`/api/duels/${duelId}/`);
          if (!res.ok) return;
          const data = await res.json();
          if (data.status === 'active') {
            setStatus('Opponent joined—go!');
            window.location.href = `/duels/${duelId}/`;
            clearInterval(pollTimer);
          } else if (data.status === 'completed' || data.status === 'expired') {
            setStatus(`Duel ${data.status}. Winner: ${data.winner || 'n/a'}`);
            clearInterval(pollTimer);
          }
        } catch (e) {}
      }, 4000);
    }

    const createForm = document.getElementById('duelCreateForm');
    if (createForm) {
      createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userId) { alert('Log in to create a duel.'); return; }
        const formData = new FormData(createForm);
        const payload = Object.fromEntries(formData.entries());
        payload.question_count = Number(payload.question_count || 5);
        try {
          const res = await fetch('/api/duels/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Could not create duel');
            return;
          }
          codeBox.textContent = data.code;
          playLink.href = data.play_url;
          createdWrap.classList.remove('d-none');
          setStatus('Waiting for opponent to join…');
          startPolling(data.id);
        } catch (err) {
          alert('Something went wrong creating the duel.');
        }
      });
    }

    const copyBtn = document.getElementById('copyCodeBtn');
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(codeBox.textContent.trim());
          copyBtn.textContent = 'Copied';
          setTimeout(() => copyBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy', 1200);
        } catch (e) {}
      });
    }

    const joinForm = document.getElementById('duelJoinForm');
    if (joinForm) {
      joinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!userId) { alert('Log in to join a duel.'); return; }
        const formData = new FormData(joinForm);
        const payload = { code: (formData.get('code') || '').trim() };
        if (!payload.code) { alert('Enter a party code.'); return; }
        try {
          const res = await fetch('/api/duels/join/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json();
          if (!res.ok) {
            alert(data.error || 'Could not join duel');
            return;
          }
          window.location.href = data.play_url;
        } catch (err) {
          alert('Something went wrong joining the duel.');
        }
      });
    }
  </script>
  {% include 'footer.html' %}
</body>
</html>
